<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Comisiones de Venta con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="file"] { display: none; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        #settings-panel, #auth-section, #app-container { transition: all 0.5s ease-in-out; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto space-y-8">
        <!-- Auth Section -->
        <div id="auth-section" class="bg-white rounded-xl shadow-lg p-8 space-y-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center">Bienvenido</h1>
            <p class="text-gray-500 text-center">Inicia sesión o regístrate para guardar tu historial de comisiones.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="email" class="text-sm font-medium text-gray-700 block mb-2">Email</label><input type="email" id="email" placeholder="tu@email.com" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="password" class="text-sm font-medium text-gray-700 block mb-2">Contraseña</label><input type="password" id="password" placeholder="••••••••" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Iniciar Sesión</button>
                <button id="signupBtn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Registrarse</button>
            </div>
            <p id="auth-error" class="text-red-500 text-sm text-center"></p>
        </div>

        <!-- App Container -->
        <div id="app-container" class="hidden">
             <div class="bg-white rounded-xl shadow-lg relative">
                <div class="flex justify-between items-center p-4 border-b border-gray-200">
                    <p class="text-sm text-gray-600">Sesión iniciada como: <span id="user-email" class="font-bold"></span></p>
                    <div>
                        <button id="settings-btn" class="text-gray-400 hover:text-gray-600 mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <button id="logoutBtn" class="bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">Salir</button>
                    </div>
                </div>
                <div id="settings-panel" class="p-8 space-y-4 bg-gray-50 hidden">
                     <h2 class="text-xl font-bold text-gray-800 text-center">Configuración</h2>
                     <div><label for="apiKey" class="text-sm font-medium text-gray-700 block mb-2">Tu API Key de Google AI</label><input type="password" id="apiKey" placeholder="Pega tu clave de API aquí" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><p class="text-xs text-gray-500 mt-1">Tu clave se guarda en tu navegador. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Obtén una clave aquí</a>.</p></div>
                     <button id="saveApiBtn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Guardar Clave</button>
                </div>
                <div class="p-8 space-y-6">
                    <div class="text-center"><h1 class="text-3xl font-bold text-gray-800">Calculadora de Comisiones</h1><p class="text-gray-500 mt-2">Ingresa los datos o carga un PDF para que la IA los extraiga.</p></div>
                    <div><label for="pdfUpload" id="pdfUploadLabel" class="w-full cursor-pointer bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 flex items-center justify-center gap-2 transition-all duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg><span>Cargar Factura en PDF</span></label><input type="file" id="pdfUpload" accept="application/pdf" disabled><p id="pdf-status" class="text-center text-sm text-gray-500 mt-2"></p></div>
                    <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-gray-500">O ingresa manualmente</span></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="numeroFacturaInput" class="text-sm font-medium text-gray-700 block mb-2">N° de Factura (Opcional)</label><input type="text" id="numeroFacturaInput" placeholder="Ej: 0062-00021241" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                        <div><label for="clienteInput" class="text-sm font-medium text-gray-700 block mb-2">Cliente (Opcional)</label><input type="text" id="clienteInput" placeholder="Ej: 5 EMES COMERCIAL SA" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                        <div><label for="montoVenta" class="text-sm font-medium text-gray-700 block mb-2">Monto final de la venta ($)</label><input type="number" id="montoVenta" placeholder="Ej: 13227.71" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                        <div><label for="cantidadArticulos" class="text-sm font-medium text-gray-700 block mb-2">Cantidad de artículos</label><input type="number" id="cantidadArticulos" placeholder="Ej: 2" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                    </div>
                    <div><button id="calcularBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 mt-4">Calcular y Agregar</button></div>
                    <div id="resultado" class="pt-4 text-center"></div>
                </div>
            </div>

            <div id="history-container" class="bg-white rounded-xl shadow-lg p-8 space-y-4 mt-8">
                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Historial de Comisiones</h2><button id="clearHistoryBtn" class="text-sm text-red-500 hover:text-red-700 hover:underline">Borrar Historial</button></div>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N° Factura</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Venta</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Artículos</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comisión</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th></tr></thead><tbody id="history-body" class="bg-white divide-y divide-gray-200"></tbody><tfoot class="bg-gray-50"><tr><th scope="row" colspan="5" class="px-6 py-3 text-right text-sm font-bold text-gray-800 uppercase tracking-wider">Total</th><td id="history-total" class="px-6 py-3 text-left text-sm font-bold text-gray-800" colspan="2"></td></tr></tfoot></table><p id="empty-history" class="text-center text-gray-500 py-8">No hay comisiones registradas.</p></div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            deleteDoc,
            doc,
            query,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        // IMPORTANT: Replace with your actual Firebase config object
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const appContainer = document.getElementById('app-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        
        const montoVentaInput = document.getElementById('montoVenta');
        const cantidadArticulosInput = document.getElementById('cantidadArticulos');
        const numeroFacturaInput = document.getElementById('numeroFacturaInput');
        const clienteInput = document.getElementById('clienteInput');
        const calcularBtn = document.getElementById('calcularBtn');
        const resultadoDiv = document.getElementById('resultado');
        const pdfUploadInput = document.getElementById('pdfUpload');
        const pdfUploadLabel = document.getElementById('pdfUploadLabel');
        const pdfStatus = document.getElementById('pdf-status');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const apiKeyInput = document.getElementById('apiKey');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const historyBody = document.getElementById('history-body');
        const historyTotal = document.getElementById('history-total');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const historyTable = document.querySelector('#history-container table');
        const emptyHistoryMsg = document.getElementById('empty-history');
        
        let apiKey = '';
        let currentUser = null;
        let unsubscribeHistory = null; // To detach the listener on logout

        // --- Auth Functions ---
        signupBtn.addEventListener('click', async () => {
            try {
                authError.textContent = '';
                await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                // User will be automatically logged in by onAuthStateChanged
            } catch (error) {
                console.error("Signup error:", error);
                authError.textContent = "Error al registrar: " + error.message;
            }
        });

        loginBtn.addEventListener('click', async () => {
            try {
                authError.textContent = '';
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                // User will be automatically logged in by onAuthStateChanged
            } catch (error) {
                console.error("Login error:", error);
                authError.textContent = "Error al iniciar sesión: " + error.message;
            }
        });
        
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                authSection.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                checkApiKey();
                loadHistory(); // Load user-specific history
            } else {
                // User is signed out
                currentUser = null;
                if(unsubscribeHistory) unsubscribeHistory(); // Detach old listener
                authSection.classList.remove('hidden');
                appContainer.classList.add('hidden');
                renderHistory([]); // Clear the visible history
            }
        });

        // --- App Logic ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        function formatCurrency(value) { return value.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' }); }

        function renderHistory(commissionHistory) {
            historyBody.innerHTML = '';
            if (commissionHistory.length === 0) {
                historyTable.classList.add('hidden');
                emptyHistoryMsg.classList.remove('hidden');
                historyTotal.textContent = formatCurrency(0);
                return;
            }
            historyTable.classList.remove('hidden');
            emptyHistoryMsg.classList.add('hidden');
            let total = 0;
            commissionHistory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.numeroFactura || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.nombreCliente || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(item.montoVenta)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.cantidadArticulos}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(item.comisionCalculada)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <button data-id="${item.id}" class="text-red-600 hover:text-red-900 delete-btn">Eliminar</button>
                    </td>
                `;
                historyBody.appendChild(row);
                total += item.comisionCalculada;
            });
            historyTotal.textContent = formatCurrency(total);

            // Add event listeners to new delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    if (confirm('¿Estás seguro de que quieres eliminar esta comisión?')) {
                        await deleteCommission(docId);
                    }
                });
            });
        }
        
        async function saveCommission(commissionData) {
            if (!currentUser) return;
            try {
                const userHistoryCollection = collection(db, 'users', currentUser.uid, 'history');
                await addDoc(userHistoryCollection, commissionData);
            } catch (error) {
                console.error("Error saving commission: ", error);
                mostrarError("No se pudo guardar la comisión.");
            }
        }

        function loadHistory() {
            if (!currentUser) return;
            if (unsubscribeHistory) unsubscribeHistory(); // Detach previous listener if exists

            const userHistoryCollection = collection(db, 'users', currentUser.uid, 'history');
            unsubscribeHistory = onSnapshot(query(userHistoryCollection), (snapshot) => {
                const commissionHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory(commissionHistory);
            });
        }
        
        async function deleteCommission(docId) {
            if (!currentUser) return;
            try {
                const docRef = doc(db, 'users', currentUser.uid, 'history', docId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting commission:", error);
                mostrarError("No se pudo eliminar la comisión.");
            }
        }

        clearHistoryBtn.addEventListener('click', async () => {
            if (!currentUser || !confirm('¿Estás seguro de que quieres borrar TODO tu historial? Esta acción no se puede deshacer.')) return;
            
            const userHistoryCollection = collection(db, 'users', currentUser.uid, 'history');
            const snapshot = await getDocs(userHistoryCollection);
            // Firestore doesn't have a bulk delete for collections from the client-side, so we delete one by one.
            snapshot.docs.forEach(async (document) => {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'history', document.id));
            });
        });
        
        async function calcularComision() {
            resultadoDiv.innerHTML = '';
            const montoVenta = parseFloat(montoVentaInput.value);
            const cantidadArticulos = parseInt(cantidadArticulosInput.value, 10);
            const numeroFactura = numeroFacturaInput.value.trim();
            const nombreCliente = clienteInput.value.trim();
            
            if (isNaN(montoVenta) || montoVenta <= 0) { mostrarError('Ingresa un monto de venta válido.'); return; }
            if (isNaN(cantidadArticulos) || cantidadArticulos < 0) { mostrarError('Ingresa una cantidad de artículos válida.'); return; }

            const comisionTotal = (montoVenta * 0.8266 * 0.007) + (cantidadArticulos * 20);
            
            const newCommission = {
                numeroFactura: numeroFactura,
                nombreCliente: nombreCliente,
                montoVenta: montoVenta,
                cantidadArticulos: cantidadArticulos,
                comisionCalculada: comisionTotal,
                createdAt: new Date() // Store timestamp for potential sorting
            };

            await saveCommission(newCommission);
            // The onSnapshot listener will automatically re-render the history
            
            mostrarResultado(comisionTotal);

            montoVentaInput.value = '';
            cantidadArticulosInput.value = '';
            numeroFacturaInput.value = '';
            clienteInput.value = '';
            numeroFacturaInput.focus();
        }

        function mostrarResultado(comision) {
            resultadoDiv.innerHTML = `<div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg fade-in"><p class="font-semibold">Última Comisión Calculada:</p><p class="text-3xl font-bold mt-1">${formatCurrency(comision)}</p></div>`;
        }
        
        function mostrarError(mensaje) {
            resultadoDiv.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg fade-in"><p class="font-semibold">Error</p><p>${mensaje}</p></div>`;
        }
        
        function checkApiKey() {
            apiKey = localStorage.getItem('googleApiKey');
            if (apiKey) {
                pdfUploadInput.disabled = false;
                pdfUploadLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                pdfUploadLabel.classList.add('hover:bg-gray-900');
                pdfStatus.textContent = 'IA lista para analizar PDFs.';
            } else {
                pdfUploadInput.disabled = true;
                pdfUploadLabel.classList.add('opacity-50', 'cursor-not-allowed');
                pdfUploadLabel.classList.remove('hover:bg-gray-900');
                pdfStatus.textContent = 'Se necesita una API Key para usar la IA. Ve a ⚙️.';
            }
        }

        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden');
            if (!settingsPanel.classList.contains('hidden')) apiKeyInput.value = localStorage.getItem('googleApiKey') || '';
        });

        saveApiBtn.addEventListener('click', () => {
            const newApiKey = apiKeyInput.value.trim();
            if (newApiKey) {
                localStorage.setItem('googleApiKey', newApiKey);
                pdfStatus.textContent = '✅ Clave guardada. ¡IA activada!';
            } else {
                localStorage.removeItem('googleApiKey');
                pdfStatus.textContent = 'Clave eliminada. La IA está desactivada.';
            }
            checkApiKey();
            settingsPanel.classList.add('hidden');
        });

        pdfUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') return;
            pdfStatus.textContent = '📖 Leyendo PDF...';
            resultadoDiv.innerHTML = '';
            try {
                const pdfText = await extractTextFromPdf(file);
                pdfStatus.textContent = '🧠 Analizando información...';
                await extractInfoWithAI(pdfText);
            } catch (error) {
                console.error('Error procesando el PDF:', error);
                mostrarError('No se pudo leer el archivo PDF.');
                pdfStatus.textContent = 'Error al leer el PDF.';
            }
        });

        async function extractTextFromPdf(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    try {
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        if (pdf.numPages === 0) { reject(new Error("El PDF no tiene páginas.")); return; }
                        const page = await pdf.getPage(1);
                        const textContent = await page.getTextContent();
                        resolve(textContent.items.map(item => item.str).join(' '));
                    } catch (error) { reject(error); }
                };
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        async function extractInfoWithAI(text) {
            if (!apiKey) { mostrarError("No hay una API Key configurada para la IA."); return; }
            
            const prompt = `
                Analiza el siguiente texto de una factura para extraer 2 campos específicos. Sigue estas reglas al pie de la letra:

                1.  **cantidadArticulos**: Busca la tabla de productos que contiene una columna llamada "Cantidad". Debes sumar todos los números que aparezcan en esa columna. Por ejemplo, si bajo "Cantidad" hay un "1" y en otra fila otro "1", el total es 2.

                2.  **montoVenta**: Al final del documento, en la sección de totales, busca la palabra "TOTAL" en mayúsculas. El valor que necesitas es el importe numérico que está en la misma línea que esa palabra. Ejemplo: "TOTAL 13227,71". El monto es 13227.71. Asegúrate de tratar la coma como separador decimal.

                Devuelve un objeto JSON con las claves "cantidadArticulos" y "montoVenta". Si algún dato no se encuentra, su valor debe ser null.

                Texto de la factura para analizar:
                ---
                ${text.substring(0, 8000)}
                ---
            `;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            montoVenta: { type: "NUMBER" },
                            cantidadArticulos: { type: "NUMBER" }
                        }
                    }
                },
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error en la API: ${response.status} ${response.statusText}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                    if (jsonResponse.montoVenta != null) montoVentaInput.value = jsonResponse.montoVenta;
                    if (jsonResponse.cantidadArticulos != null) cantidadArticulosInput.value = jsonResponse.cantidadArticulos;
                    pdfStatus.textContent = '✅ ¡Información extraída con éxito!';
                } else { throw new Error("La respuesta de la IA no tuvo el formato esperado."); }
            } catch(error) {
                console.error("Error llamando a la IA:", error);
                mostrarError("La IA no pudo extraer los datos. Revisa tu API Key y el formato del PDF.");
                pdfStatus.textContent = "Error en el análisis.";
            }
        }
        
        calcularBtn.addEventListener('click', calcularComision);
        cantidadArticulosInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') calcularBtn.click(); });
    </script>
</body>
</html>
